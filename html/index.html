<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç»„åˆä¼˜åŒ–æŸ¥æ‰¾ç¨‹åº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .file-upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-upload-text {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .file-upload-hint {
            color: #8d959f;
            font-size: 14px;
        }

        .hidden-file-input {
            display: none;
        }

        .input-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }

        .input-tab {
            padding: 12px 24px;
            background: #e9ecef;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .input-tab.active {
            background: #667eea;
            color: white;
        }

        .input-content {
            display: none;
        }

        .input-content.active {
            display: block;
        }

        .product-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s ease;
        }

        .product-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .product-name {
            font-weight: bold;
            color: #495057;
            flex: 1;
        }

        .product-price {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: #495057;
        }

        .constraint-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .constraint-inputs input {
            margin: 0;
        }

        .max-possible {
            color: #28a745;
            font-weight: bold;
            text-align: center;
        }

        .solutions {
            margin-top: 30px;
        }

        .solution-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #28a745;
        }

        .solution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .solution-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
        }

        .solution-cost {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .solution-products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }

        .solution-product {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin-bottom: 20px;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bee5eb;
            margin-bottom: 20px;
        }

        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .search-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .search-progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .search-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .constraint-inputs {
                grid-template-columns: 1fr;
            }

            .solution-products {
                grid-template-columns: 1fr;
            }

            .input-tabs {
                flex-direction: column;
            }

            .input-tab {
                margin-right: 0;
                margin-bottom: 5px;
                border-radius: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›’ å•†å“ç»„åˆä¼˜åŒ–æŸ¥æ‰¾ç¨‹åº</h1>
            <p>æ™ºèƒ½è®¡ç®—æœ€ä¼˜é‡‡è´­æ–¹æ¡ˆï¼ŒèŠ‚çº¦æˆæœ¬ï¼Œæå‡æ•ˆç‡</p>
        </div>

        <div class="main-content">
            <!-- å•†å“æ•°æ®è¾“å…¥åŒºåŸŸ -->
            <div class="section">
                <h2>ğŸ“¦ å•†å“æ•°æ®</h2>
                
                <div class="input-tabs">
                    <button class="input-tab active" onclick="switchInputTab('manual')">æ‰‹åŠ¨è¾“å…¥</button>
                    <button class="input-tab" onclick="switchInputTab('file')">æ–‡ä»¶å¯¼å…¥</button>
                </div>

                <!-- æ‰‹åŠ¨è¾“å…¥æ ‡ç­¾é¡µ -->
                <div id="manual-input" class="input-content active">
                    <div class="form-group">
                        <label for="csvInput">è¯·è¾“å…¥å•†å“æ•°æ®ï¼ˆCSVæ ¼å¼ï¼šå•†å“å,ä»·æ ¼ï¼‰ï¼š</label>
                        <textarea id="csvInput" rows="8" placeholder="å†œå¤«å±±æ³‰ ä¸œæ–¹æ ‘å¶ èŒ‰è‰èŠ±èŒ¶500ml*15ç“¶,25.50
ç»´ä»– 250ml*24ç›’ æŸ æª¬èŒ¶,18.80
æ¤°æ ‘ æ¤°æ±å‘³ 245ml*24ç›’ æ¤°å­æ±,22.30
å†œå¤«å±±æ³‰ 380ml/ç“¶ 24ç“¶/ç®± é¥®ç”¨å¤©ç„¶æ°´,15.00
å†œå¤«å±±æ³‰ 550ml*24ç“¶/ç®± çŸ¿æ³‰æ°´,20.00"></textarea>
                    </div>
                    <button onclick="loadProductsFromText()">è½½å…¥å•†å“æ•°æ®</button>
                    <button onclick="loadDefaultData()">ä½¿ç”¨é»˜è®¤æ•°æ®</button>
                </div>

                <!-- æ–‡ä»¶å¯¼å…¥æ ‡ç­¾é¡µ -->
                <div id="file-input" class="input-content">
                    <div class="file-upload-area" id="fileUploadArea" onclick="triggerFileInput()">
                        <div class="file-upload-icon">ğŸ“</div>
                        <div class="file-upload-text">ç‚¹å‡»é€‰æ‹©CSVæ–‡ä»¶æˆ–å°†æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <div class="file-upload-hint">æ”¯æŒCSVæ ¼å¼æ–‡ä»¶ï¼Œç¬¬ä¸€åˆ—ä¸ºå•†å“åï¼Œç¬¬äºŒåˆ—ä¸ºä»·æ ¼</div>
                    </div>
                    <input type="file" id="csvFileInput" class="hidden-file-input" accept=".csv,.txt" onchange="handleFileSelect(event)">
                </div>
            </div>

            <!-- ä»·æ ¼èŒƒå›´è®¾ç½® -->
            <div class="section">
                <h2>ğŸ’° ä»·æ ¼èŒƒå›´è®¾ç½®</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="minPrice">æœ€å°æ€»ä»·ï¼š</label>
                        <input type="number" id="minPrice" value="495" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="maxPrice">æœ€å¤§æ€»ä»·ï¼š</label>
                        <input type="number" id="maxPrice" value="500" step="0.01" min="0">
                    </div>
                </div>
            </div>

            <!-- å•†å“çº¦æŸè®¾ç½® -->
            <div class="section" id="constraintsSection" style="display: none;">
                <h2>ğŸ“Š å•†å“é‡‡è´­çº¦æŸ</h2>
                <div class="info">
                    <strong>è¯´æ˜ï¼š</strong>è®¾ç½®æ¯ä¸ªå•†å“çš„æœ€å°å’Œæœ€å¤§é‡‡è´­æ•°é‡ã€‚ç³»ç»Ÿä¼šæ ¹æ®æœ€å¤§æ€»ä»·è‡ªåŠ¨è®¡ç®—æ¯ä¸ªå•†å“çš„æœ€å¤§å¯èƒ½æ•°é‡ã€‚
                </div>
                <div>
                    <button onclick="useDefaultConstraints()">ä½¿ç”¨é»˜è®¤çº¦æŸ</button>
                    <button onclick="resetConstraints()">é‡ç½®æ‰€æœ‰çº¦æŸ</button>
                </div>
                <div id="productConstraints"></div>
            </div>

            <!-- æœç´¢æ§åˆ¶ -->
            <div class="section" id="searchSection" style="display: none;">
                <h2>ğŸ” æœç´¢è®¾ç½®</h2>
                <div class="form-group">
                    <label for="maxSolutions">æœ€å¤§è§£å†³æ–¹æ¡ˆæ•°é‡ï¼š</label>
                    <input type="number" id="maxSolutions" value="50" min="1" max="1000">
                </div>
                <button id="startSearch" onclick="startSearch()">å¼€å§‹æœç´¢</button>
                <button id="stopSearch" onclick="stopSearch()" style="display: none;" disabled>åœæ­¢æœç´¢</button>
            </div>

            <!-- æœç´¢ç»“æœ -->
            <div id="resultsSection" style="display: none;">
                <div class="section">
                    <h2>ğŸ“‹ æœç´¢ç»“æœ</h2>
                    <div id="searchStatus"></div>
                    <div id="searchProgress" style="display: none;">
                        <div class="search-progress">
                            <div class="search-progress-bar" id="progressBar"></div>
                        </div>
                        <div id="progressText" style="text-align: center; margin-top: 10px;">0%</div>
                    </div>
                    <div id="solutions"></div>
                </div>

                <!-- å¯¼å‡ºåŠŸèƒ½ -->
                <div class="export-section" id="exportSection" style="display: none;">
                    <h3>ğŸ“¤ å¯¼å‡ºç»“æœ</h3>
                    <button onclick="exportToCSV()">å¯¼å‡ºä¸ºCSV</button>
                    <button onclick="exportToJSON()">å¯¼å‡ºä¸ºJSON</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let constraints = {};
        let solutions = [];
        let isSearching = false;
        let searchTimeout = null;

        // åˆ‡æ¢è¾“å…¥æ ‡ç­¾é¡µ
        function switchInputTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.input-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.input-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            event.target.classList.add('active');
            document.getElementById(tabName + '-input').classList.add('active');
        }

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerFileInput() {
            document.getElementById('csvFileInput').click();
        }

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('fileUploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // å¤„ç†æ–‡ä»¶å†…å®¹
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.txt')) {
                showError('è¯·é€‰æ‹©CSVæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result;
                document.getElementById('csvInput').value = csvData;
                loadProductsFromText();
                showSuccess(`æ–‡ä»¶ "${file.name}" å¯¼å…¥æˆåŠŸ`);
            };
            reader.onerror = function() {
                showError('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
            };
            reader.readAsText(file, 'UTF-8');
        }

        // è½½å…¥é»˜è®¤å•†å“æ•°æ®
        function loadDefaultData() {
            const defaultData = `å†œå¤«å±±æ³‰ ä¸œæ–¹æ ‘å¶ èŒ‰è‰èŠ±èŒ¶500ml*15ç“¶,25.50
ç»´ä»– 250ml*24ç›’ æŸ æª¬èŒ¶,18.80
æ¤°æ ‘ æ¤°æ±å‘³ 245ml*24ç›’ æ¤°å­æ±,22.30
å†œå¤«å±±æ³‰ 380ml/ç“¶ 24ç“¶/ç®± é¥®ç”¨å¤©ç„¶æ°´,15.00
å†œå¤«å±±æ³‰ 550ml*24ç“¶/ç®± çŸ¿æ³‰æ°´,20.00`;
            document.getElementById('csvInput').value = defaultData;
            loadProductsFromText();
        }

        // ä»æ–‡æœ¬è½½å…¥å•†å“æ•°æ®
        function loadProductsFromText() {
            const csvData = document.getElementById('csvInput').value.trim();
            if (!csvData) {
                showError('è¯·å…ˆè¾“å…¥å•†å“æ•°æ®');
                return;
            }

            products = [];
            const lines = csvData.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const name = parts[0].trim();
                    const price = parseFloat(parts[1].trim());
                    
                    if (name && !isNaN(price) && price >= 0) {
                        products.push({ name, price });
                    }
                }
            }

            if (products.length === 0) {
                showError('æœªèƒ½è§£æå‡ºæœ‰æ•ˆçš„å•†å“æ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                return;
            }

            showSuccess(`æˆåŠŸè½½å…¥ ${products.length} ä¸ªå•†å“`);
            updateConstraintsSection();
            document.getElementById('constraintsSection').style.display = 'block';
            document.getElementById('searchSection').style.display = 'block';
        }

        // è®¡ç®—æœ€å¤§å¯èƒ½æ•°é‡
        function calculateMaxQuantity(productPrice, maxTotal) {
            if (productPrice === 0) return 100;
            return Math.floor(maxTotal / productPrice);
        }

        // æ›´æ–°çº¦æŸè®¾ç½®åŒºåŸŸ
        function updateConstraintsSection() {
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 500;
            const container = document.getElementById('productConstraints');
            container.innerHTML = '';

            products.forEach((product, index) => {
                const maxPossible = calculateMaxQuantity(product.price, maxPrice);
                
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                productDiv.innerHTML = `
                    <div class="product-header">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">Â¥${product.price.toFixed(2)}/ç®±</div>
                    </div>
                    <div class="constraint-inputs">
                        <div>
                            <label>æœ€å°æ•°é‡ï¼š</label>
                            <input type="number" id="min_${index}" value="0" min="0" max="${maxPossible}" onchange="validateConstraints(${index})">
                        </div>
                        <div>
                            <label>æœ€å¤§æ•°é‡ï¼š</label>
                            <input type="number" id="max_${index}" value="${maxPossible}" min="0" max="${maxPossible}" onchange="validateConstraints(${index})">
                        </div>
                        <div class="max-possible">
                            æœ€å¤§å¯èƒ½ï¼š${maxPossible}ç®±
                        </div>
                    </div>
                `;
                container.appendChild(productDiv);
            });
        }

        // éªŒè¯çº¦æŸæ¡ä»¶
        function validateConstraints(index) {
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 500;
            const maxPossible = calculateMaxQuantity(products[index].price, maxPrice);
            
            const minInput = document.getElementById(`min_${index}`);
            const maxInput = document.getElementById(`max_${index}`);
            
            let minVal = parseInt(minInput.value) || 0;
            let maxVal = parseInt(maxInput.value) || 0;

            // ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å¯èƒ½å€¼
            if (minVal > maxPossible) {
                minVal = maxPossible;
                minInput.value = minVal;
                showWarning(`å•†å“ "${products[index].name}" çš„æœ€å°å€¼å·²è°ƒæ•´ä¸ºæœ€å¤§å¯èƒ½å€¼ ${maxPossible}`);
            }

            if (maxVal > maxPossible) {
                maxVal = maxPossible;
                maxInput.value = maxVal;
                showWarning(`å•†å“ "${products[index].name}" çš„æœ€å¤§å€¼å·²è°ƒæ•´ä¸ºæœ€å¤§å¯èƒ½å€¼ ${maxPossible}`);
            }

            // ç¡®ä¿æœ€å°å€¼ä¸å¤§äºæœ€å¤§å€¼
            if (minVal > maxVal) {
                minInput.value = maxVal;
                showWarning(`å•†å“ "${products[index].name}" çš„æœ€å°å€¼å·²è°ƒæ•´ä¸ºä¸è¶…è¿‡æœ€å¤§å€¼`);
            }
        }

        // ä½¿ç”¨é»˜è®¤çº¦æŸ
        function useDefaultConstraints() {
            const defaultConstraints = {
                "å†œå¤«å±±æ³‰ ä¸œæ–¹æ ‘å¶ èŒ‰è‰èŠ±èŒ¶500ml*15ç“¶": { min: 4, max: null },
                "ç»´ä»– 250ml*24ç›’ æŸ æª¬èŒ¶": { min: 1, max: null },
                "æ¤°æ ‘ æ¤°æ±å‘³ 245ml*24ç›’ æ¤°å­æ±": { min: 1, max: null },
                "å†œå¤«å±±æ³‰ 380ml/ç“¶ 24ç“¶/ç®± é¥®ç”¨å¤©ç„¶æ°´": { min: 0, max: 0 },
                "å†œå¤«å±±æ³‰ 550ml*24ç“¶/ç®± çŸ¿æ³‰æ°´": { min: 0, max: 0 }
            };

            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 500;

            products.forEach((product, index) => {
                const constraint = defaultConstraints[product.name];
                const maxPossible = calculateMaxQuantity(product.price, maxPrice);
                
                let minVal = constraint ? constraint.min : 0;
                let maxVal = constraint && constraint.max !== null ? constraint.max : maxPossible;

                // ç¡®ä¿çº¦æŸå€¼ä¸è¶…è¿‡æœ€å¤§å¯èƒ½å€¼
                minVal = Math.min(minVal, maxPossible);
                maxVal = Math.min(maxVal, maxPossible);
                minVal = Math.min(minVal, maxVal);

                document.getElementById(`min_${index}`).value = minVal;
                document.getElementById(`max_${index}`).value = maxVal;
            });

            showSuccess('å·²åº”ç”¨é»˜è®¤çº¦æŸæ¡ä»¶');
        }

        // é‡ç½®çº¦æŸ
        function resetConstraints() {
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 500;
            
            products.forEach((product, index) => {
                const maxPossible = calculateMaxQuantity(product.price, maxPrice);
                document.getElementById(`min_${index}`).value = 0;
                document.getElementById(`max_${index}`).value = maxPossible;
            });

            showSuccess('å·²é‡ç½®æ‰€æœ‰çº¦æŸæ¡ä»¶');
        }

        // å¼€å§‹æœç´¢
        function startSearch() {
            if (products.length === 0) {
                showError('è¯·å…ˆè½½å…¥å•†å“æ•°æ®');
                return;
            }

            // éªŒè¯ä»·æ ¼èŒƒå›´
            const minPrice = parseFloat(document.getElementById('minPrice').value);
            const maxPrice = parseFloat(document.getElementById('maxPrice').value);
            
            if (isNaN(minPrice) || isNaN(maxPrice) || minPrice < 0 || maxPrice < 0) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼èŒƒå›´');
                return;
            }

            if (minPrice > maxPrice) {
                showError('æœ€å°ä»·æ ¼ä¸èƒ½å¤§äºæœ€å¤§ä»·æ ¼');
                return;
            }

            // æ”¶é›†çº¦æŸæ¡ä»¶
            constraints = {};
            for (let i = 0; i < products.length; i++) {
                const minVal = parseInt(document.getElementById(`min_${i}`).value) || 0;
                const maxVal = parseInt(document.getElementById(`max_${i}`).value) || 0;
                constraints[i] = { min: minVal, max: maxVal };
            }

            // é‡ç½®æœç´¢çŠ¶æ€
            isSearching = true;
            solutions = [];
            
            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('startSearch').style.display = 'none';
            document.getElementById('stopSearch').style.display = 'inline-block';
            document.getElementById('stopSearch').disabled = false;
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('searchProgress').style.display = 'block';
            document.getElementById('exportSection').style.display = 'none';
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('solutions').innerHTML = '';
            
            showSearchStatus('æ­£åœ¨åˆå§‹åŒ–æœç´¢...', true);

            // ä½¿ç”¨setTimeoutæ¥æ¨¡æ‹Ÿå¼‚æ­¥æœç´¢ï¼Œé¿å…é˜»å¡UI
            setTimeout(() => {
                performSearch(minPrice, maxPrice);
            }, 100);
        }

        // æ‰§è¡Œæœç´¢
        function performSearch(minTotal, maxTotal) {
            if (!isSearching) return;

            const maxSolutions = parseInt(document.getElementById('maxSolutions').value) || 50;
            const solutionFinder = new SolutionFinder(minTotal, maxTotal, constraints);
            
            let foundCount = 0;
            let iterationCount = 0;
            const startTime = Date.now();
            const maxIterations = 100000; // æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯

            function findNextBatch() {
                if (!isSearching) {
                    finishSearch(foundCount, startTime, 'æœç´¢å·²åœæ­¢');
                    return;
                }

                const batchSize = 50; // æ¯æ‰¹å¤„ç†50æ¬¡å°è¯•
                let batchCount = 0;
                let foundInBatch = 0;

                while (batchCount < batchSize && foundCount < maxSolutions && isSearching && iterationCount < maxIterations) {
                    const result = solutionFinder.findNextSolution();
                    iterationCount++;
                    batchCount++;

                    if (result.success) {
                        solutions.push({
                            quantities: result.quantities,
                            totalCost: result.totalCost
                        });
                        foundCount++;
                        foundInBatch++;
                    } else if (result.finished) {
                        // æœç´¢ç©ºé—´å·²è€—å°½
                        finishSearch(foundCount, startTime, `æœç´¢å®Œæˆï¼æ‰¾åˆ° ${foundCount} ä¸ªè§£å†³æ–¹æ¡ˆ`);
                        return;
                    }
                }

                // æ›´æ–°è¿›åº¦
                const progress = Math.min(100, (iterationCount / maxIterations) * 100);
                updateProgress(progress, foundCount);

                // å¦‚æœæ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆï¼Œæ›´æ–°æ˜¾ç¤º
                if (foundInBatch > 0) {
                    displaySolutions();
                }

                // æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶
                if (foundCount >= maxSolutions) {
                    finishSearch(foundCount, startTime, `å·²è¾¾åˆ°æœ€å¤§è§£å†³æ–¹æ¡ˆæ•°é‡é™åˆ¶ (${maxSolutions})`);
                    return;
                }

                if (iterationCount >= maxIterations) {
                    finishSearch(foundCount, startTime, `å·²è¾¾åˆ°æœ€å¤§æœç´¢æ¬¡æ•°é™åˆ¶`);
                    return;
                }

                if (!isSearching) {
                    finishSearch(foundCount, startTime, 'æœç´¢å·²åœæ­¢');
                    return;
                }

                // ç»§ç»­ä¸‹ä¸€æ‰¹æœç´¢
                showSearchStatus(`æ­£åœ¨æœç´¢ä¸­... å·²æ‰¾åˆ° ${foundCount} ä¸ªè§£å†³æ–¹æ¡ˆ (å·²æœç´¢ ${iterationCount} æ¬¡)`, true);
                searchTimeout = setTimeout(findNextBatch, 10);
            }

            findNextBatch();
        }

        // å®Œæˆæœç´¢
        function finishSearch(foundCount, startTime, message) {
            isSearching = false;
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }

            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('startSearch').style.display = 'inline-block';
            document.getElementById('stopSearch').style.display = 'none';
            document.getElementById('searchProgress').style.display = 'none';
            
            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            const finalMessage = foundCount > 0 ? 
                `${message} (è€—æ—¶: ${duration}ç§’)` : 
                `${message}ã€‚æœªæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„è§£å†³æ–¹æ¡ˆ (è€—æ—¶: ${duration}ç§’)`;
            
            showSearchStatus(finalMessage, false);
            
            if (foundCount > 0) {
                document.getElementById('exportSection').style.display = 'block';
                displaySolutions(); // ç¡®ä¿æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            }
        }

        // åœæ­¢æœç´¢
        function stopSearch() {
            isSearching = false;
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }
            
            document.getElementById('stopSearch').disabled = true;
            showSearchStatus('æ­£åœ¨åœæ­¢æœç´¢...', false);
        }

        // æ›´æ–°æœç´¢è¿›åº¦
        function updateProgress(percentage, foundCount) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${percentage.toFixed(1)}% - å·²æ‰¾åˆ° ${foundCount} ä¸ªè§£å†³æ–¹æ¡ˆ`;
        }

        // æ˜¾ç¤ºæœç´¢çŠ¶æ€
        function showSearchStatus(message, loading) {
            const statusDiv = document.getElementById('searchStatus');
            statusDiv.innerHTML = loading ? 
                `<div class="loading"><div class="spinner"></div>${message}</div>` :
                `<div class="success">${message}</div>`;
        }

        // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
        function displaySolutions() {
            const container = document.getElementById('solutions');
            container.innerHTML = '';

            solutions.forEach((solution, index) => {
                const solutionDiv = document.createElement('div');
                solutionDiv.className = 'solution-item';
                
                let productsHtml = '';
                solution.quantities.forEach((qty, productIndex) => {
                    if (qty > 0) {
                        const product = products[productIndex];
                        const itemCost = qty * product.price;
                        productsHtml += `
                            <div class="solution-product">
                                <strong>${product.name}</strong><br>
                                ${qty} ç®± Ã— Â¥${product.price.toFixed(2)} = Â¥${itemCost.toFixed(2)}
                            </div>
                        `;
                    }
                });

                solutionDiv.innerHTML = `
                    <div class="solution-header">
                        <div class="solution-number">æ–¹æ¡ˆ #${index + 1}</div>
                        <div class="solution-cost">æ€»æˆæœ¬: Â¥${solution.totalCost.toFixed(2)}</div>
                    </div>
                    <div class="solution-products">
                        ${productsHtml}
                    </div>
                `;
                
                container.appendChild(solutionDiv);
            });
        }

        // è§£å†³æ–¹æ¡ˆæŸ¥æ‰¾å™¨ç±»
        class SolutionFinder {
            constructor(minTotal, maxTotal, constraints) {
                this.minTotal = minTotal;
                this.maxTotal = maxTotal;
                this.constraints = constraints;
                this.foundSolutions = new Set();
                this.stack = [];
                this.initialize();
            }

            initialize() {
                const initialQuantities = new Array(products.length).fill(0);
                
                // è®¾ç½®æœ€å°çº¦æŸ
                for (let idx in this.constraints) {
                    initialQuantities[idx] = this.constraints[idx].min;
                }

                const initialCost = this.calculateCost(initialQuantities);
                this.stack.push({ index: 0, quantities: initialQuantities, cost: initialCost });
            }

            calculateCost(quantities) {
                return quantities.reduce((total, qty, index) => total + qty * products[index].price, 0);
            }

            findNextSolution() {
                if (this.stack.length === 0) {
                    return { success: false, finished: true };
                }

                const state = this.stack.pop();
                const { index, quantities, cost } = state;

                if (index === products.length) {
                    if (cost >= this.minTotal && cost <= this.maxTotal) {
                        // éªŒè¯çº¦æŸæ¡ä»¶
                        let valid = true;
                        for (let prodIdx in this.constraints) {
                            const constraint = this.constraints[prodIdx];
                            if (quantities[prodIdx] < constraint.min || quantities[prodIdx] > constraint.max) {
                                valid = false;
                                break;
                            }
                        }

                        if (valid) {
                            const solutionKey = quantities.join(',');
                            if (!this.foundSolutions.has(solutionKey)) {
                                this.foundSolutions.add(solutionKey);
                                return {
                                    success: true,
                                    quantities: [...quantities],
                                    totalCost: cost,
                                    finished: false
                                };
                            }
                        }
                    }
                    return { success: false, finished: false };
                }

                const constraint = this.constraints[index];
                const minQty = constraint ? constraint.min : 0;
                const maxQty = constraint ? constraint.max : Math.floor(this.maxTotal / products[index].price);

                // ä»æœ€å¤§å€¼å‘æœ€å°å€¼éå†ï¼ˆä¼˜å…ˆé«˜æ•°é‡çš„ç»„åˆï¼‰
                for (let qty = maxQty; qty >= minQty; qty--) {
                    const newQuantities = [...quantities];
                    newQuantities[index] = qty;
                    const newCost = cost + (qty - quantities[index]) * products[index].price;

                    if (newCost <= this.maxTotal) {
                        this.stack.push({
                            index: index + 1,
                            quantities: newQuantities,
                            cost: newCost
                        });
                    }
                }

                return { success: false, finished: false };
            }
        }

        // å¯¼å‡ºä¸ºCSV
        function exportToCSV() {
            if (solutions.length === 0) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„è§£å†³æ–¹æ¡ˆ');
                return;
            }

            let csv = 'æ–¹æ¡ˆç¼–å·,æ€»æˆæœ¬';
            products.forEach(product => {
                csv += ',' + product.name;
            });
            csv += '\n';

            solutions.forEach((solution, index) => {
                let row = `${index + 1},${solution.totalCost.toFixed(2)}`;
                solution.quantities.forEach(qty => {
                    row += ',' + qty;
                });
                csv += row + '\n';
            });

            downloadFile(csv, 'product_solutions.csv', 'text/csv');
        }

        // å¯¼å‡ºä¸ºJSON
        function exportToJSON() {
            if (solutions.length === 0) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„è§£å†³æ–¹æ¡ˆ');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                priceRange: {
                    min: parseFloat(document.getElementById('minPrice').value),
                    max: parseFloat(document.getElementById('maxPrice').value)
                },
                products: products,
                constraints: constraints,
                solutions: solutions.map((solution, index) => ({
                    id: index + 1,
                    totalCost: solution.totalCost,
                    quantities: solution.quantities,
                    products: solution.quantities.map((qty, productIndex) => ({
                        name: products[productIndex].name,
                        quantity: qty,
                        unitPrice: products[productIndex].price,
                        subtotal: qty * products[productIndex].price
                    })).filter(item => item.quantity > 0)
                }))
            };

            downloadFile(JSON.stringify(exportData, null, 2), 'product_solutions.json', 'application/json');
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            showMessage(message, 'error');
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
        function showWarning(message) {
            showMessage(message, 'error');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            // ç§»é™¤ä¹‹å‰çš„æ¶ˆæ¯
            const existingMessages = document.querySelectorAll('.error, .success, .info');
            existingMessages.forEach(msg => msg.remove());

            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(messageDiv, mainContent.firstChild);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // ç›‘å¬ä»·æ ¼èŒƒå›´å˜åŒ–
        document.getElementById('minPrice').addEventListener('change', function() {
            if (products.length > 0) {
                updateConstraintsSection();
            }
        });

        document.getElementById('maxPrice').addEventListener('change', function() {
            if (products.length > 0) {
                updateConstraintsSection();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            setupDragAndDrop();
            loadDefaultData();
        });
    </script>
</body>
</html>